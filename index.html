<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>–°—É–ø–µ—Ä –§–µ—Ä–º–µ—Ä Pro</title>
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#10b981">
    <meta name="apple-mobile-web-app-capable" content="yes">
    
    <style>
        :root {
            --primary: #10b981;
            --primary-dark: #047857;
            --bg: #f8fafc;
            --surface: #ffffff;
            --text-main: #334155;
            --text-light: #64748b;
            --danger: #ef4444;
            --border: #e2e8f0;
            --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            background-color: var(--bg);
            color: var(--text-main);
            margin: 0;
            padding: 20px;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        .container { max-width: 500px; margin: 0 auto; width: 100%; position: relative; }

        header { 
            text-align: center; 
            margin-bottom: 20px; 
            padding-bottom: 10px;
            border-bottom: 2px solid var(--border);
        }
        h1 { margin: 0; font-size: 1.25rem; font-weight: 800; color: var(--text-main); text-transform: uppercase; letter-spacing: 1px; }
        .subtitle { font-size: 0.85rem; color: var(--text-light); margin-top: 4px; }

        /* Controls Bar */
        .controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: var(--surface);
            padding: 10px 16px;
            border-radius: 12px;
            box-shadow: var(--shadow);
            margin-bottom: 20px;
            gap: 10px;
        }
        
        /* Auto Switch */
        .switch-wrapper { display: flex; align-items: center; gap: 8px; flex: 1; }
        .switch-label { font-size: 0.8rem; font-weight: 600; line-height: 1.2; }
        .switch { position: relative; display: inline-block; width: 40px; height: 22px; flex-shrink: 0; }
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #cbd5e1; transition: .4s; border-radius: 24px; }
        .slider:before { position: absolute; content: ""; height: 16px; width: 16px; left: 3px; bottom: 3px; background-color: white; transition: .4s; border-radius: 50%; box-shadow: 0 2px 4px rgba(0,0,0,0.2); }
        input:checked + .slider { background-color: var(--primary); }
        input:checked + .slider:before { transform: translateX(18px); }

        /* Trade Button (Small) */
        .btn-icon {
            background: #eff6ff;
            color: #3b82f6;
            border: none;
            border-radius: 8px;
            padding: 8px 12px;
            font-weight: 700;
            font-size: 0.9rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 6px;
            transition: background 0.2s;
        }
        .btn-icon:active { background: #dbeafe; transform: scale(0.95); }

        /* Farm Grid */
        .card {
            background: var(--surface);
            border-radius: 16px;
            box-shadow: var(--shadow);
            padding: 20px;
            margin-bottom: 20px;
        }
        
        .section-header {
            font-size: 0.75rem;
            text-transform: uppercase;
            letter-spacing: 1.5px;
            font-weight: 700;
            color: var(--text-light);
            margin-bottom: 16px;
            text-align: center;
        }

        .input-grid { display: grid; grid-template-columns: repeat(5, 1fr); gap: 8px; margin-bottom: 24px; }
        .dog-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; padding: 0 20px; }

        .animal-unit { display: flex; flex-direction: column; align-items: center; }
        .animal-icon { font-size: 1.6rem; margin-bottom: 6px; }
        
        input[type="tel"] {
            width: 100%; height: 44px; text-align: center;
            border: 2px solid var(--border); border-radius: 12px;
            font-size: 1.2rem; font-weight: 700; color: var(--text-main);
            background: #f1f5f9; transition: all 0.2s; -moz-appearance: textfield;
        }
        input[type="tel"]:focus { outline: none; border-color: var(--primary); background: #fff; }

        /* Dice Section */
        .dice-container { display: flex; justify-content: center; gap: 20px; margin: 10px 0 24px 0; perspective: 1000px; }
        .die {
            width: 75px; height: 75px;
            background: linear-gradient(145deg, #ffffff, #f0f0f0);
            border-radius: 16px;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            box-shadow: 4px 4px 8px #d1d5db, -4px -4px 8px #ffffff;
            border: 1px solid rgba(255,255,255,0.8);
        }
        .die.green-die { border-bottom: 4px solid #4ade80; }
        .die.red-die { border-bottom: 4px solid #f87171; }
        .die-icon { font-size: 2.2rem; line-height: 1; }
        .die-label { font-size: 0.6rem; font-weight: 700; color: var(--text-light); margin-top: 2px; text-transform: uppercase; }

        /* Status & Logs */
        .status-area { min-height: 50px; margin-bottom: 16px; display: flex; flex-direction: column; gap: 8px; }
        .alert-box {
            padding: 12px; border-radius: 10px; font-weight: 600; font-size: 0.9rem;
            display: flex; flex-direction: column; gap: 10px; text-align: center;
            animation: slideIn 0.3s ease-out;
        }
        .alert-danger { background-color: #fee2e2; color: #991b1b; border: 1px solid #fecaca; }
        .alert-success { background-color: #dcfce7; color: #166534; border: 1px solid #bbf7d0; }
        .alert-info { text-align: center; color: var(--text-light); font-style: italic; font-size: 0.85rem; }

        /* Main Button */
        .btn {
            width: 100%; padding: 16px; border: none; border-radius: 12px;
            font-size: 1rem; font-weight: 700; text-transform: uppercase; letter-spacing: 0.5px;
            cursor: pointer; transition: transform 0.1s;
        }
        .btn:active { transform: scale(0.98); }
        .btn-primary { background-color: var(--primary); color: white; box-shadow: 0 4px 12px rgba(16, 185, 129, 0.3); }
        .btn-primary:disabled { background-color: #cbd5e1; box-shadow: none; cursor: not-allowed; }
        
        .btn-action-group { display: flex; gap: 8px; }
        .btn-sm { padding: 10px; font-size: 0.8rem; flex: 1; border-radius: 8px; border: none; cursor: pointer; font-weight: 600; }
        .btn-danger { background-color: var(--danger); color: white; }
        .btn-secondary { background-color: var(--text-main); color: white; }

        /* --- MODAL STYLES --- */
        .modal-backdrop {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.5); z-index: 100;
            display: flex; align-items: center; justify-content: center;
            opacity: 0; pointer-events: none; transition: opacity 0.3s;
            backdrop-filter: blur(2px);
        }
        .modal-backdrop.active { opacity: 1; pointer-events: all; }
        
        .modal-content {
            background: var(--surface); width: 90%; max-width: 360px;
            border-radius: 20px; padding: 24px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.2);
            transform: translateY(20px); transition: transform 0.3s;
        }
        .modal-backdrop.active .modal-content { transform: translateY(0); }

        .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .modal-title { font-size: 1.2rem; font-weight: 800; color: var(--text-main); }
        .close-btn { background: none; border: none; font-size: 1.5rem; color: #94a3b8; cursor: pointer; padding: 0; }

        .trade-row { display: flex; align-items: center; justify-content: space-between; margin-bottom: 15px; }
        .trade-select {
            padding: 10px; border-radius: 10px; border: 2px solid var(--border);
            font-size: 1rem; width: 45%; background: #fff;
        }
        .trade-arrow { font-size: 1.2rem; color: var(--text-light); }
        
        .trade-info {
            background: #f0f9ff; color: #0369a1; padding: 10px;
            border-radius: 8px; font-size: 0.9rem; text-align: center;
            margin-bottom: 20px; border: 1px solid #bae6fd;
        }

        .amount-ctrl { display: flex; align-items: center; justify-content: center; gap: 15px; margin-bottom: 20px; }
        .btn-circle {
            width: 40px; height: 40px; border-radius: 50%; border: none;
            background: #e2e8f0; font-size: 1.2rem; font-weight: bold; cursor: pointer;
            display: flex; align-items: center; justify-content: center;
        }
        .trade-amount { font-size: 1.5rem; font-weight: 800; width: 50px; text-align: center; }

        /* Animations */
        @keyframes shake {
            0% { transform: rotate(0deg); } 25% { transform: rotate(10deg); }
            50% { transform: rotate(-10deg); } 75% { transform: rotate(5deg); } 100% { transform: rotate(0deg); }
        }
        .shaking { animation: shake 0.4s ease-in-out infinite; }
        .changed { animation: flashGreen 1s ease-out; }
        @keyframes flashGreen { 50% { background-color: #bbf7d0; transform: scale(1.05); } }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>–°—É–ø–µ—Ä –§–µ—Ä–º–µ—Ä</h1>
            <div class="subtitle">Pro Assistant</div>
        </header>

        <div class="controls">
            <div class="switch-wrapper">
                <label class="switch">
                    <input type="checkbox" id="autoMode" checked>
                    <span class="slider"></span>
                </label>
                <span class="switch-label">–ê–≤—Ç–æ<br>—Ä—ñ—Å—Ç</span>
            </div>
            <button class="btn-icon" onclick="openTradeModal()">
                üîÑ –û–±–º—ñ–Ω
            </button>
        </div>

        <div class="card">
            <div class="section-header">–¢–≤–æ—è –§–µ—Ä–º–∞</div>
            <div class="input-grid">
                <div class="animal-unit"><div class="animal-icon">üê∞</div><input type="tel" id="inp-rabbit" value="0"></div>
                <div class="animal-unit"><div class="animal-icon">üêë</div><input type="tel" id="inp-sheep" value="0"></div>
                <div class="animal-unit"><div class="animal-icon">üê∑</div><input type="tel" id="inp-pig" value="0"></div>
                <div class="animal-unit"><div class="animal-icon">üêÆ</div><input type="tel" id="inp-cow" value="0"></div>
                <div class="animal-unit"><div class="animal-icon">üê¥</div><input type="tel" id="inp-horse" value="0"></div>
            </div>

            <div class="section-header" style="margin-top: 25px;">–û—Ö–æ—Ä–æ–Ω–∞</div>
            <div class="dog-grid">
                <div class="animal-unit">
                    <div class="animal-icon">üêï</div>
                    <input type="tel" id="inp-small-dog" value="0">
                </div>
                <div class="animal-unit">
                    <div class="animal-icon">üêï‚Äçü¶∫</div>
                    <input type="tel" id="inp-big-dog" value="0">
                </div>
            </div>
        </div>

        <div class="dice-container">
            <div id="d1" class="die green-die">
                <div class="die-icon" id="d1-icon">üé≤</div>
                <div class="die-label" id="d1-label">D1</div>
            </div>
            <div id="d2" class="die red-die">
                <div class="die-icon" id="d2-icon">üé≤</div>
                <div class="die-label" id="d2-label">D2</div>
            </div>
        </div>

        <div id="statusArea" class="status-area">
            <div class="alert-info">–ì–æ—Ç–æ–≤–∏–π –¥–æ –≥—Ä–∏</div>
        </div>

        <button id="rollBtn" class="btn btn-primary">–ö–∏–Ω—É—Ç–∏ –∫—É–±–∏–∫–∏</button>
    </div>

    <div class="modal-backdrop" id="tradeModal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">–†–∏–Ω–æ–∫</div>
                <button class="close-btn" onclick="closeTradeModal()">&times;</button>
            </div>
            
            <div class="trade-row">
                <select id="tradeFrom" class="trade-select" onchange="updateTradeCalc()">
                    <option value="rabbit">üê∞ –ó–∞—î—Ü—å</option>
                    <option value="sheep">üêë –í—ñ–≤—Ü—è</option>
                    <option value="pig">üê∑ –°–≤–∏–Ω—è</option>
                    <option value="cow">üêÆ –ö–æ—Ä–æ–≤–∞</option>
                    <option value="horse">üê¥ –ö—ñ–Ω—å</option>
                    <option value="small-dog">üêï –ú–∞–ª–∞</option>
                    <option value="big-dog">üêï‚Äçü¶∫ –í–µ–ª–∏–∫–∞</option>
                </select>
                <div class="trade-arrow">‚û°Ô∏è</div>
                <select id="tradeTo" class="trade-select" onchange="updateTradeCalc()">
                    </select>
            </div>

            <div id="tradeRateInfo" class="trade-info">
                –ö—É—Ä—Å: ...
            </div>

            <div class="section-header">–ö—ñ–ª—å–∫—ñ—Å—Ç—å –¥–ª—è –æ—Ç—Ä–∏–º–∞–Ω–Ω—è</div>
            <div class="amount-ctrl">
                <button class="btn-circle" onclick="changeAmount(-1)">-</button>
                <div class="trade-amount" id="tradeAmount">1</div>
                <button class="btn-circle" onclick="changeAmount(1)">+</button>
            </div>

            <button class="btn btn-primary" onclick="performTrade()">–û–±–º—ñ–Ω—è—Ç–∏</button>
        </div>
    </div>

    <script>
        // --- CONFIG & RULES (GRANNA VERSION) ---
        const DIE_GREEN = [
            {id:'rabbit', icon:'üê∞', name:'–ó–∞—î—Ü—å'}, {id:'rabbit', icon:'üê∞', name:'–ó–∞—î—Ü—å'}, 
            {id:'rabbit', icon:'üê∞', name:'–ó–∞—î—Ü—å'}, {id:'rabbit', icon:'üê∞', name:'–ó–∞—î—Ü—å'}, 
            {id:'rabbit', icon:'üê∞', name:'–ó–∞—î—Ü—å'}, {id:'rabbit', icon:'üê∞', name:'–ó–∞—î—Ü—å'},
            {id:'sheep', icon:'üêë', name:'–í—ñ–≤—Ü—è'}, {id:'sheep', icon:'üêë', name:'–í—ñ–≤—Ü—è'},
            {id:'sheep', icon:'üêë', name:'–í—ñ–≤—Ü—è'}, 
            {id:'pig', icon:'üê∑', name:'–°–≤–∏–Ω—è'}, 
            {id:'cow', icon:'üêÆ', name:'–ö–æ—Ä–æ–≤–∞'}, 
            {id:'wolf', icon:'üê∫', name:'–í–æ–≤–∫'}
        ];

        const DIE_RED = [
            {id:'rabbit', icon:'üê∞', name:'–ó–∞—î—Ü—å'}, {id:'rabbit', icon:'üê∞', name:'–ó–∞—î—Ü—å'}, 
            {id:'rabbit', icon:'üê∞', name:'–ó–∞—î—Ü—å'}, {id:'rabbit', icon:'üê∞', name:'–ó–∞—î—Ü—å'}, 
            {id:'rabbit', icon:'üê∞', name:'–ó–∞—î—Ü—å'}, {id:'rabbit', icon:'üê∞', name:'–ó–∞—î—Ü—å'},
            {id:'sheep', icon:'üêë', name:'–í—ñ–≤—Ü—è'}, {id:'sheep', icon:'üêë', name:'–í—ñ–≤—Ü—è'},
            {id:'pig', icon:'üê∑', name:'–°–≤–∏–Ω—è'}, {id:'pig', icon:'üê∑', name:'–°–≤–∏–Ω—è'},
            {id:'horse', icon:'üê¥', name:'–ö—ñ–Ω—å'},
            {id:'fox', icon:'ü¶ä', name:'–õ–∏—Å–∏—Ü—è'}
        ];

        // --- EXCHANGE RULES ---
        // Basic Value in Rabbits: Rabbit=1, Sheep=6, Pig=12, Cow=36, Horse=72, SmallDog=6, BigDog=36
        // Direct Trades defined by box rules:
        const TRADE_PAIRS = {
            'rabbit': ['sheep'],
            'sheep': ['rabbit', 'pig', 'small-dog'],
            'pig': ['sheep', 'cow'],
            'cow': ['pig', 'horse', 'big-dog'],
            'horse': ['cow'],
            'small-dog': ['sheep'],
            'big-dog': ['cow']
        };

        const RATES = {
            'rabbit_sheep': 6,  // 6 Rabbits -> 1 Sheep
            'sheep_rabbit': 1/6,// 1 Sheep -> 6 Rabbits
            
            'sheep_pig': 2,     // 2 Sheep -> 1 Pig
            'pig_sheep': 0.5,   // 1 Pig -> 2 Sheep
            
            'pig_cow': 3,       // 3 Pigs -> 1 Cow
            'cow_pig': 1/3,     // 1 Cow -> 3 Pigs
            
            'cow_horse': 2,     // 2 Cows -> 1 Horse
            'horse_cow': 0.5,   // 1 Horse -> 2 Cows

            'sheep_small-dog': 1, // 1 Sheep -> 1 Small Dog
            'small-dog_sheep': 1, // 1 Small Dog -> 1 Sheep

            'cow_big-dog': 1,     // 1 Cow -> 1 Big Dog
            'big-dog_cow': 1      // 1 Big Dog -> 1 Cow
        };

        const NAMES = {
            'rabbit': 'üê∞', 'sheep': 'üêë', 'pig': 'üê∑', 'cow': 'üêÆ', 'horse': 'üê¥',
            'small-dog': 'üêï', 'big-dog': 'üêï‚Äçü¶∫'
        };

        // --- STATE & UTILS ---
        const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        
        function getVal(id) { return parseInt(document.getElementById(`inp-${id}`).value) || 0; }
        function setVal(id, val) { 
            const el = document.getElementById(`inp-${id}`);
            el.value = Math.max(0, val);
            el.classList.remove('changed');
            void el.offsetWidth;
            el.classList.add('changed');
        }

        function playTone(type) {
            if (audioCtx.state === 'suspended') audioCtx.resume();
            const osc = audioCtx.createOscillator();
            const gain = audioCtx.createGain();
            osc.connect(gain);
            gain.connect(audioCtx.destination);
            
            const now = audioCtx.currentTime;
            if (type === 'roll') {
                osc.frequency.setValueAtTime(150, now);
                osc.frequency.linearRampToValueAtTime(50, now + 0.15);
                gain.gain.setValueAtTime(0.1, now);
                gain.gain.linearRampToValueAtTime(0, now + 0.15);
            } else if (type === 'danger') {
                osc.type = 'sawtooth';
                osc.frequency.setValueAtTime(100, now);
                osc.frequency.linearRampToValueAtTime(50, now + 0.3);
                gain.gain.setValueAtTime(0.2, now);
                gain.gain.linearRampToValueAtTime(0, now + 0.3);
            } else if (type === 'success') {
                osc.type = 'sine';
                osc.frequency.setValueAtTime(400, now);
                osc.frequency.exponentialRampToValueAtTime(600, now + 0.2);
                gain.gain.setValueAtTime(0.1, now);
                gain.gain.linearRampToValueAtTime(0, now + 0.2);
            } else if (type === 'trade') {
                osc.type = 'triangle';
                osc.frequency.setValueAtTime(600, now);
                gain.gain.setValueAtTime(0.1, now);
                gain.gain.linearRampToValueAtTime(0, now + 0.15);
            }
            osc.start(); osc.stop(now + 0.5);
        }

        function getSecureRandom(arr) {
            const cryptoArr = new Uint32Array(1);
            window.crypto.getRandomValues(cryptoArr);
            return arr[cryptoArr[0] % arr.length];
        }

        // --- GAME LOGIC ---
        document.getElementById('rollBtn').addEventListener('click', () => {
            const btn = document.getElementById('rollBtn');
            const d1El = document.getElementById('d1');
            const d2El = document.getElementById('d2');
            const statusArea = document.getElementById('statusArea');

            btn.disabled = true;
            statusArea.innerHTML = '';
            d1El.classList.add('shaking');
            d2El.classList.add('shaking');
            playTone('roll');

            if (navigator.vibrate) navigator.vibrate(20);

            setTimeout(() => {
                d1El.classList.remove('shaking');
                d2El.classList.remove('shaking');
                btn.disabled = false;

                const r1 = getSecureRandom(DIE_GREEN);
                const r2 = getSecureRandom(DIE_RED);

                document.getElementById('d1-icon').innerText = r1.icon;
                document.getElementById('d1-label').innerText = r1.name;
                document.getElementById('d2-icon').innerText = r2.icon;
                document.getElementById('d2-label').innerText = r2.name;

                processRound(r1, r2);

            }, 500);
        });

        function processRound(r1, r2) {
            const statusArea = document.getElementById('statusArea');
            const autoMode = document.getElementById('autoMode').checked;
            
            let isWolf = (r1.id === 'wolf');
            let isFox = (r2.id === 'fox');

            if (isWolf || isFox) {
                playTone('danger');
                if (navigator.vibrate) navigator.vibrate([100, 50, 100]);

                let alertBox = document.createElement('div');
                alertBox.className = 'alert-box alert-danger';
                
                let msg = `‚ö†Ô∏è –£–í–ê–ì–ê: `;
                if (isWolf && isFox) msg += "–í–û–í–ö –¢–ê –õ–ò–°–ò–¶–Ø!";
                else if (isWolf) msg += "–í–û–í–ö!";
                else if (isFox) msg += "–õ–ò–°–ò–¶–Ø!";
                alertBox.innerHTML = `<span>${msg}</span>`;

                if (isFox) {
                    const group = document.createElement('div');
                    group.className = 'btn-action-group';
                    group.innerHTML = `
                        <button class="btn btn-sm btn-secondary" onclick="useDog('small', this)">üêï -1 –°–æ–±–∞–∫–∞</button>
                        <button class="btn btn-sm btn-danger" onclick="applyFoxDamage(this)">ü¶ä –°–ø–∏—Å–∞—Ç–∏</button>
                    `;
                    alertBox.appendChild(group);
                }

                if (isWolf) {
                    const group = document.createElement('div');
                    group.className = 'btn-action-group';
                    group.innerHTML = `
                        <button class="btn btn-sm btn-secondary" onclick="useDog('big', this)">üêï‚Äçü¶∫ -1 –°–æ–±–∞–∫–∞</button>
                        <button class="btn btn-sm btn-danger" onclick="applyWolfDamage(this)">üê∫ –°–ø–∏—Å–∞—Ç–∏</button>
                    `;
                    alertBox.appendChild(group);
                }

                statusArea.appendChild(alertBox);
                
                const potential = calculateGrowth(r1, r2);
                if (potential.length > 0) {
                    let info = document.createElement('div');
                    info.className = 'alert-info';
                    info.innerHTML = `–Ø–∫—â–æ –≤–∏–∂–∏–ª–∏, –¥–æ–¥–∞–π—Ç–µ –≤—Ä—É—á–Ω—É: <br><b>${potential.join(', ')}</b>`;
                    statusArea.appendChild(info);
                }
                return;
            }

            // GROWTH
            playTone('success');
            const changes = calculateGrowth(r1, r2);
            
            if (changes.length > 0) {
                let successBox = document.createElement('div');
                successBox.className = 'alert-box alert-success';
                successBox.innerHTML = `üéâ –ü—Ä–∏—Ä—ñ—Å—Ç:<br>${changes.join(', ')}`;
                statusArea.appendChild(successBox);

                if (autoMode) applyGrowthLogic(r1, r2);
            } else {
                statusArea.innerHTML = '<div class="alert-info">–ë–µ–∑ –ø—Ä–∏—Ä–æ—Å—Ç—É</div>';
            }
            checkVictory();
        }

        function calculateGrowth(r1, r2) {
            let counts = {};
            [r1, r2].forEach(r => counts[r.id] = (counts[r.id] || 0) + 1);
            let result = [];
            ['rabbit', 'sheep', 'pig', 'cow', 'horse'].forEach(type => {
                let onDice = counts[type] || 0;
                if (onDice > 0) {
                    let onFarm = getVal(type);
                    let newBorn = Math.floor((onFarm + onDice) / 2);
                    if (newBorn > 0) result.push(`+${newBorn} ${NAMES[type]}`);
                }
            });
            return result;
        }

        function applyGrowthLogic(r1, r2) {
            let counts = {};
            [r1, r2].forEach(r => counts[r.id] = (counts[r.id] || 0) + 1);
            ['rabbit', 'sheep', 'pig', 'cow', 'horse'].forEach(type => {
                let onDice = counts[type] || 0;
                if (onDice > 0) {
                    let onFarm = getVal(type);
                    let newBorn = Math.floor((onFarm + onDice) / 2);
                    if (newBorn > 0) setVal(type, onFarm + newBorn);
                }
            });
        }

        // --- TRADE MODAL LOGIC ---
        function openTradeModal() {
            document.getElementById('tradeModal').classList.add('active');
            updateTradeToOptions();
        }
        function closeTradeModal() {
            document.getElementById('tradeModal').classList.remove('active');
        }

        // Update "To" dropdown based on "From" selection
        function updateTradeToOptions() {
            const from = document.getElementById('tradeFrom').value;
            const toSelect = document.getElementById('tradeTo');
            toSelect.innerHTML = '';
            
            const allowed = TRADE_PAIRS[from] || [];
            allowed.forEach(target => {
                const opt = document.createElement('option');
                opt.value = target;
                opt.innerText = `${NAMES[target] || ''} ${formatName(target)}`;
                toSelect.appendChild(opt);
            });
            updateTradeCalc();
        }

        let currentTradeAmount = 1;

        function changeAmount(delta) {
            currentTradeAmount = Math.max(1, currentTradeAmount + delta);
            document.getElementById('tradeAmount').innerText = currentTradeAmount;
            updateTradeCalc();
        }

        function updateTradeCalc() {
            const from = document.getElementById('tradeFrom').value;
            const to = document.getElementById('tradeTo').value;
            const rateKey = `${from}_${to}`;
            let rate = RATES[rateKey];

            const infoEl = document.getElementById('tradeRateInfo');
            
            if (!rate) {
                // Try reverse rate math if implicit? No, explicit table is safer.
                infoEl.innerText = "–û–±–º—ñ–Ω –Ω–µ–º–æ–∂–ª–∏–≤–∏–π";
                return;
            }

            // Calculation
            // If Rate is > 1 (e.g. 6 rabbits = 1 sheep). I give 6*N rabbits, get 1*N sheep.
            // If Rate is < 1 (e.g. 1 sheep = 6 rabbits). Wait, logic inverse.
            
            // Let's standarize: RATE is "How many FROM units needed for 1 TO unit"
            // Rabbit->Sheep (Rate 6). Need 6 Rabbit for 1 Sheep.
            // Sheep->Rabbit (Rate 1/6). Need 0.16 Sheep for 1 Rabbit? No. 
            // 1 Sheep = 6 Rabbits. So Cost is 1, Gain is 6.

            let cost = 0;
            let gain = currentTradeAmount; // We want to buy N items

            if (rate >= 1) {
                // "Upscaling" or Equal (6 Rabbits -> 1 Sheep)
                cost = rate * currentTradeAmount;
            } else {
                // "Downscaling" (1 Sheep -> 6 Rabbits). 
                // Logic: 1 Sheep = 6 Rabbits.
                // If I want 6 Rabbits, cost is 1 Sheep.
                // Formula: Cost = Want * Rate?  6 * (1/6) = 1. Yes.
                cost = currentTradeAmount * rate;
            }
            
            // Check if cost is integer (can't trade half a sheep)
            if (!Number.isInteger(cost)) {
                 infoEl.innerHTML = `<span style="color:var(--danger)">–ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω–∞ –∫—ñ–ª—å–∫—ñ—Å—Ç—å –¥–ª—è –æ–±–º—ñ–Ω—É!</span><br>–ü–æ—Ç—Ä—ñ–±–Ω–æ –∫—Ä–∞—Ç–Ω–æ ${1/rate}`;
            } else {
                infoEl.innerHTML = `–í—ñ–¥–¥–∞—Ç–∏: <b>${cost} ${NAMES[from]}</b><br>–û—Ç—Ä–∏–º–∞—Ç–∏: <b>${gain} ${NAMES[to]}</b>`;
            }
        }

        function performTrade() {
            const from = document.getElementById('tradeFrom').value;
            const to = document.getElementById('tradeTo').value;
            const rateKey = `${from}_${to}`;
            const rate = RATES[rateKey];

            let cost = (rate >= 1) ? rate * currentTradeAmount : currentTradeAmount * rate;

            if (!Number.isInteger(cost)) {
                alert("–ù–µ–º–æ–∂–ª–∏–≤–æ –∑–¥—ñ–π—Å–Ω–∏—Ç–∏ –æ–±–º—ñ–Ω: –Ω–µ—Ü—ñ–ª–∞ –∫—ñ–ª—å–∫—ñ—Å—Ç—å —Ç–≤–∞—Ä–∏–Ω.");
                return;
            }

            const currentStock = getVal(from);
            if (currentStock >= cost) {
                setVal(from, currentStock - cost);
                setVal(to, getVal(to) + currentTradeAmount);
                playTone('trade');
                closeTradeModal();
                checkVictory();
            } else {
                alert(`–ù–µ –≤–∏—Å—Ç–∞—á–∞—î —Ç–≤–∞—Ä–∏–Ω! –ü–æ—Ç—Ä—ñ–±–Ω–æ ${cost} ${NAMES[from]}`);
            }
        }

        function formatName(id) {
            const map = {
                'rabbit':'–ó–∞—î—Ü—å', 'sheep':'–í—ñ–≤—Ü—è', 'pig':'–°–≤–∏–Ω—è', 
                'cow':'–ö–æ—Ä–æ–≤–∞', 'horse':'–ö—ñ–Ω—å', 'small-dog':'–ú–∞–ª–∞', 'big-dog':'–í–µ–ª–∏–∫–∞'
            };
            return map[id];
        }

        // --- HELPER ACTIONS ---
        window.useDog = function(size, btn) {
            const id = size === 'small' ? 'small-dog' : 'big-dog';
            let current = getVal(id);
            if (current > 0) {
                setVal(id, current - 1);
                removeAlertButton(btn);
            } else {
                alert("–£ –≤–∞—Å –Ω–µ–º–∞—î —Ç–∞–∫–æ—ó —Å–æ–±–∞–∫–∏!");
            }
        }
        window.applyFoxDamage = function(btn) {
            if(confirm("–õ–∏—Å–∏—Ü—è –∑'—ó—Å—Ç—å –∑–∞–π—Ü—ñ–≤?")) {
                setVal('rabbit', 0);
                removeAlertButton(btn);
            }
        }
        window.applyWolfDamage = function(btn) {
            if(confirm("–í–æ–≤–∫ –∑'—ó—Å—Ç—å —Å—Ç–∞–¥–æ?")) {
                setVal('sheep', 0); setVal('pig', 0); setVal('cow', 0);
                removeAlertButton(btn);
            }
        }
        function removeAlertButton(btn) {
            btn.parentElement.style.opacity = '0.5';
            btn.parentElement.style.pointerEvents = 'none';
        }
        
        function checkVictory() {
            if (getVal('rabbit')>0 && getVal('sheep')>0 && getVal('pig')>0 && 
                getVal('cow')>0 && getVal('horse')>0) {
                
                let winBox = document.createElement('div');
                winBox.className = 'alert-box alert-success';
                winBox.innerHTML = `üèÜ <b>–ü–ï–†–ï–ú–û–ì–ê!</b><br>–í–∏ –∑—ñ–±—Ä–∞–ª–∏ –°—É–ø–µ—Ä –§–µ—Ä–º—É!`;
                document.getElementById('statusArea').prepend(winBox);
                if (navigator.vibrate) navigator.vibrate([200,100,200,100,500]);
            }
        }

        if ('serviceWorker' in navigator) navigator.serviceWorker.register('sw.js');
    </script>
</body>
</html>
