<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>–°—É–ø–µ—Ä –§–µ—Ä–º–µ—Ä Pro</title>
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#10b981">
    <meta name="apple-mobile-web-app-capable" content="yes">
    
    <style>
        :root {
            --primary: #10b981;
            --primary-dark: #047857;
            --bg: #f8fafc;
            --surface: #ffffff;
            --text-main: #334155;
            --text-light: #64748b;
            --danger: #ef4444;
            --border: #e2e8f0;
            --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            --highlight: #dbeafe; /* Blue 100 */
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            background-color: var(--bg);
            color: var(--text-main);
            margin: 0;
            padding: 16px;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        .container { max-width: 500px; margin: 0 auto; width: 100%; position: relative; }

        header { 
            text-align: center; 
            margin-bottom: 20px; 
            padding-bottom: 10px;
            border-bottom: 2px solid var(--border);
        }
        h1 { margin: 0; font-size: 1.25rem; font-weight: 800; color: var(--text-main); text-transform: uppercase; letter-spacing: 1px; }
        .subtitle { font-size: 0.85rem; color: var(--text-light); margin-top: 4px; }

        /* Controls */
        .controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: var(--surface);
            padding: 10px 16px;
            border-radius: 12px;
            box-shadow: var(--shadow);
            margin-bottom: 20px;
            gap: 10px;
        }
        
        .switch-wrapper { display: flex; align-items: center; gap: 8px; flex: 1; }
        .switch-label { font-size: 0.8rem; font-weight: 600; line-height: 1.2; }
        .switch { position: relative; display: inline-block; width: 40px; height: 22px; flex-shrink: 0; }
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #cbd5e1; transition: .4s; border-radius: 24px; }
        .slider:before { position: absolute; content: ""; height: 16px; width: 16px; left: 3px; bottom: 3px; background-color: white; transition: .4s; border-radius: 50%; box-shadow: 0 2px 4px rgba(0,0,0,0.2); }
        input:checked + .slider { background-color: var(--primary); }
        input:checked + .slider:before { transform: translateX(18px); }

        .btn-icon {
            background: #eff6ff;
            color: #2563eb;
            border: none;
            border-radius: 8px;
            padding: 8px 16px;
            font-weight: 700;
            font-size: 0.95rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 6px;
            transition: background 0.2s;
            box-shadow: 0 2px 0 #bfdbfe;
        }
        .btn-icon:active { transform: translateY(2px); box-shadow: none; }

        /* Farm Grid */
        .card {
            background: var(--surface);
            border-radius: 16px;
            box-shadow: var(--shadow);
            padding: 20px;
            margin-bottom: 20px;
        }
        
        .section-header {
            font-size: 0.75rem;
            text-transform: uppercase;
            letter-spacing: 1.5px;
            font-weight: 700;
            color: var(--text-light);
            margin-bottom: 16px;
            text-align: center;
        }

        .input-grid { display: grid; grid-template-columns: repeat(5, 1fr); gap: 8px; margin-bottom: 24px; }
        .dog-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; padding: 0 20px; }
        .animal-unit { display: flex; flex-direction: column; align-items: center; }
        .animal-icon { font-size: 1.6rem; margin-bottom: 6px; }
        
        input[type="tel"] {
            width: 100%; height: 44px; text-align: center;
            border: 2px solid var(--border); border-radius: 12px;
            font-size: 1.2rem; font-weight: 700; color: var(--text-main);
            background: #f1f5f9; transition: all 0.2s; -moz-appearance: textfield;
        }
        input[type="tel"]:focus { outline: none; border-color: var(--primary); background: #fff; }

        /* Dice */
        .dice-container { display: flex; justify-content: center; gap: 20px; margin: 10px 0 24px 0; perspective: 1000px; }
        .die {
            width: 75px; height: 75px;
            background: linear-gradient(145deg, #ffffff, #f0f0f0);
            border-radius: 16px;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            box-shadow: 4px 4px 8px #d1d5db, -4px -4px 8px #ffffff;
            border: 1px solid rgba(255,255,255,0.8);
        }
        .die.green-die { border-bottom: 4px solid #4ade80; }
        .die.red-die { border-bottom: 4px solid #f87171; }
        .die-icon { font-size: 2.2rem; line-height: 1; }
        .die-label { font-size: 0.6rem; font-weight: 700; color: var(--text-light); margin-top: 2px; text-transform: uppercase; }

        /* Status */
        .status-area { min-height: 50px; margin-bottom: 16px; display: flex; flex-direction: column; gap: 8px; }
        .alert-box {
            padding: 12px; border-radius: 10px; font-weight: 600; font-size: 0.9rem;
            display: flex; flex-direction: column; gap: 10px; text-align: center;
            animation: slideIn 0.3s ease-out;
        }
        .alert-danger { background-color: #fee2e2; color: #991b1b; border: 1px solid #fecaca; }
        .alert-success { background-color: #dcfce7; color: #166534; border: 1px solid #bbf7d0; }
        .alert-info { text-align: center; color: var(--text-light); font-style: italic; font-size: 0.85rem; }

        .btn {
            width: 100%; padding: 16px; border: none; border-radius: 12px;
            font-size: 1rem; font-weight: 700; text-transform: uppercase; letter-spacing: 0.5px;
            cursor: pointer; transition: transform 0.1s;
        }
        .btn:active { transform: scale(0.98); }
        .btn-primary { background-color: var(--primary); color: white; box-shadow: 0 4px 12px rgba(16, 185, 129, 0.3); }
        .btn-primary:disabled { background-color: #cbd5e1; box-shadow: none; cursor: not-allowed; }
        
        .btn-action-group { display: flex; gap: 8px; }
        .btn-sm { padding: 10px; font-size: 0.8rem; flex: 1; border-radius: 8px; border: none; cursor: pointer; font-weight: 600; }
        .btn-danger { background-color: var(--danger); color: white; }
        .btn-secondary { background-color: var(--text-main); color: white; }

        /* --- NEW MARKET MODAL --- */
        .modal-backdrop {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.6); z-index: 100;
            display: flex; align-items: flex-end; /* Mobile friendly: bottom sheet */
            opacity: 0; pointer-events: none; transition: opacity 0.3s;
            backdrop-filter: blur(3px);
        }
        .modal-backdrop.active { opacity: 1; pointer-events: all; }
        @media (min-width: 500px) { .modal-backdrop { align-items: center; justify-content: center; } }

        .modal-content {
            background: var(--surface); width: 100%; max-width: 500px;
            border-top-left-radius: 24px; border-top-right-radius: 24px;
            padding: 24px 20px; box-shadow: 0 -10px 25px rgba(0,0,0,0.2);
            transform: translateY(100%); transition: transform 0.3s cubic-bezier(0.2, 0.8, 0.2, 1);
            max-height: 85vh; overflow-y: auto;
        }
        @media (min-width: 500px) { 
            .modal-content { border-radius: 24px; transform: translateY(20px); } 
        }
        .modal-backdrop.active .modal-content { transform: translateY(0); }

        .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .modal-title { font-size: 1.3rem; font-weight: 800; color: var(--text-main); }
        .close-btn { background: #f1f5f9; border: none; width: 32px; height: 32px; border-radius: 50%; font-size: 1.2rem; color: #64748b; cursor: pointer; display: flex; align-items: center; justify-content: center; }

        /* Market UI */
        .market-label { font-size: 0.85rem; font-weight: 700; color: var(--text-light); text-transform: uppercase; margin-bottom: 10px; letter-spacing: 0.5px; }
        
        /* 1. Source Selector */
        .source-grid { display: flex; gap: 8px; overflow-x: auto; padding-bottom: 10px; scrollbar-width: none; }
        .source-grid::-webkit-scrollbar { display: none; }
        
        .source-item {
            flex: 0 0 auto;
            display: flex; flex-direction: column; align-items: center;
            background: #f8fafc; border: 2px solid var(--border);
            padding: 10px; border-radius: 12px; cursor: pointer;
            min-width: 60px; transition: all 0.2s;
        }
        .source-item.active { border-color: var(--primary); background: #ecfdf5; transform: scale(1.05); }
        .source-icon { font-size: 1.8rem; margin-bottom: 4px; }
        .source-name { font-size: 0.7rem; font-weight: 600; color: var(--text-main); }

        /* 2. Offers List */
        .offers-list { display: flex; flex-direction: column; gap: 10px; margin-top: 20px; min-height: 100px; }
        .empty-offers { text-align: center; color: var(--text-light); padding: 20px; font-style: italic; }

        .offer-card {
            display: flex; align-items: center; justify-content: space-between;
            background: #fff; border: 1px solid var(--border);
            padding: 12px 16px; border-radius: 12px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.03);
        }
        .offer-info { display: flex; flex-direction: column; }
        .offer-text { font-weight: 700; font-size: 1rem; color: var(--text-main); }
        .offer-cost { font-size: 0.8rem; color: var(--danger); margin-top: 2px; font-weight: 600; }
        
        .offer-action { display: flex; align-items: center; gap: 10px; }
        .trade-btn {
            background: var(--text-main); color: white;
            border: none; padding: 10px 16px; border-radius: 8px;
            font-weight: 700; cursor: pointer;
        }
        .trade-btn:active { transform: scale(0.95); }

        /* Animations */
        @keyframes shake { 0% { transform: rotate(0deg); } 25% { transform: rotate(10deg); } 50% { transform: rotate(-10deg); } 75% { transform: rotate(5deg); } 100% { transform: rotate(0deg); } }
        .shaking { animation: shake 0.4s ease-in-out infinite; }
        .changed { animation: flashGreen 1s ease-out; }
        @keyframes flashGreen { 50% { background-color: #bbf7d0; transform: scale(1.05); } }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>–°—É–ø–µ—Ä –§–µ—Ä–º–µ—Ä</h1>
            <div class="subtitle">Pro Assistant</div>
        </header>

        <div class="controls">
            <div class="switch-wrapper">
                <label class="switch">
                    <input type="checkbox" id="autoMode" checked>
                    <span class="slider"></span>
                </label>
                <span class="switch-label">–ê–≤—Ç–æ<br>—Ä—ñ—Å—Ç</span>
            </div>
            <button class="btn-icon" onclick="openTradeModal()">
                üîÑ –û–±–º—ñ–Ω
            </button>
        </div>

        <div class="card">
            <div class="section-header">–¢–≤–æ—è –§–µ—Ä–º–∞</div>
            <div class="input-grid">
                <div class="animal-unit"><div class="animal-icon">üê∞</div><input type="tel" id="inp-rabbit" value="0"></div>
                <div class="animal-unit"><div class="animal-icon">üêë</div><input type="tel" id="inp-sheep" value="0"></div>
                <div class="animal-unit"><div class="animal-icon">üê∑</div><input type="tel" id="inp-pig" value="0"></div>
                <div class="animal-unit"><div class="animal-icon">üêÆ</div><input type="tel" id="inp-cow" value="0"></div>
                <div class="animal-unit"><div class="animal-icon">üê¥</div><input type="tel" id="inp-horse" value="0"></div>
            </div>

            <div class="section-header" style="margin-top: 25px;">–û—Ö–æ—Ä–æ–Ω–∞</div>
            <div class="dog-grid">
                <div class="animal-unit">
                    <div class="animal-icon">üêï</div>
                    <input type="tel" id="inp-small-dog" value="0">
                </div>
                <div class="animal-unit">
                    <div class="animal-icon">üêï‚Äçü¶∫</div>
                    <input type="tel" id="inp-big-dog" value="0">
                </div>
            </div>
        </div>

        <div class="dice-container">
            <div id="d1" class="die green-die">
                <div class="die-icon" id="d1-icon">üé≤</div>
                <div class="die-label" id="d1-label">D1</div>
            </div>
            <div id="d2" class="die red-die">
                <div class="die-icon" id="d2-icon">üé≤</div>
                <div class="die-label" id="d2-label">D2</div>
            </div>
        </div>

        <div id="statusArea" class="status-area">
            <div class="alert-info">–ì–æ—Ç–æ–≤–∏–π –¥–æ –≥—Ä–∏</div>
        </div>

        <button id="rollBtn" class="btn btn-primary">–ö–∏–Ω—É—Ç–∏ –∫—É–±–∏–∫–∏</button>
    </div>

    <div class="modal-backdrop" id="tradeModal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">–†–∏–Ω–æ–∫</div>
                <button class="close-btn" onclick="closeTradeModal()">&times;</button>
            </div>
            
            <div class="market-label">1. –©–æ —Ö–æ—á–µ—à –ø—Ä–æ–¥–∞—Ç–∏?</div>
            <div class="source-grid" id="sourceGrid">
                </div>

            <div class="market-label" style="margin-top: 20px">2. –î–æ—Å—Ç—É–ø–Ω—ñ –ø—Ä–æ–ø–æ–∑–∏—Ü—ñ—ó</div>
            <div class="offers-list" id="offersList">
                <div class="empty-offers">–û–±–µ—Ä–∏ —Ç–≤–∞—Ä–∏–Ω—É –∑–≤–µ—Ä—Ö—É</div>
            </div>
        </div>
    </div>

    <script>
        // --- GAME DATA ---
        const NAMES = {
            'rabbit': '–ó–∞—î—Ü—å', 'sheep': '–í—ñ–≤—Ü—è', 'pig': '–°–≤–∏–Ω—è', 
            'cow': '–ö–æ—Ä–æ–≤–∞', 'horse': '–ö—ñ–Ω—å', 'small-dog': '–ú–∞–ª–∞', 'big-dog': '–í–µ–ª–∏–∫–∞'
        };
        const ICONS = {
            'rabbit': 'üê∞', 'sheep': 'üêë', 'pig': 'üê∑', 
            'cow': 'üêÆ', 'horse': 'üê¥', 'small-dog': 'üêï', 'big-dog': 'üêï‚Äçü¶∫'
        };

        // –¢–ê–ë–õ–ò–¶–Ø –û–ë–ú–Ü–ù–£ (GRANNA)
        // –°—Ç—Ä—É–∫—Ç—É—Ä–∞: '—Ö—Ç–æ_–ø—Ä–æ–¥–∞—î—Ç—å—Å—è': [ { target: '—Ö—Ç–æ_–∫—É–ø—É—î—Ç—å—Å—è', pay: —Å–∫—ñ–ª—å–∫–∏_–≤—ñ–¥–¥–∞—Ç–∏, get: —Å–∫—ñ–ª—å–∫–∏_–æ—Ç—Ä–∏–º–∞—Ç–∏ } ]
        const OFFERS = {
            'rabbit': [
                { target: 'sheep', pay: 6, get: 1 } // 6 –ó–∞–π—Ü—ñ–≤ -> 1 –í—ñ–≤—Ü—è
            ],
            'sheep': [
                { target: 'rabbit', pay: 1, get: 6 }, // 1 –í—ñ–≤—Ü—è -> 6 –ó–∞–π—Ü—ñ–≤
                { target: 'pig', pay: 2, get: 1 },    // 2 –í—ñ–≤—Ü—ñ -> 1 –°–≤–∏–Ω—è
                { target: 'small-dog', pay: 1, get: 1 } // 1 –í—ñ–≤—Ü—è -> 1 –ú–∞–ª–∞ —Å–æ–±–∞–∫–∞
            ],
            'pig': [
                { target: 'sheep', pay: 1, get: 2 },  // 1 –°–≤–∏–Ω—è -> 2 –í—ñ–≤—Ü—ñ
                { target: 'cow', pay: 3, get: 1 }     // 3 –°–≤–∏–Ω—ñ -> 1 –ö–æ—Ä–æ–≤–∞
            ],
            'cow': [
                { target: 'pig', pay: 1, get: 3 },    // 1 –ö–æ—Ä–æ–≤–∞ -> 3 –°–≤–∏–Ω—ñ
                { target: 'horse', pay: 2, get: 1 },  // 2 –ö–æ—Ä–æ–≤–∏ -> 1 –ö—ñ–Ω—å
                { target: 'big-dog', pay: 1, get: 1 } // 1 –ö–æ—Ä–æ–≤–∞ -> 1 –í–µ–ª–∏–∫–∞ —Å–æ–±–∞–∫–∞
            ],
            'horse': [
                { target: 'cow', pay: 1, get: 2 }     // 1 –ö—ñ–Ω—å -> 2 –ö–æ—Ä–æ–≤–∏
            ],
            'small-dog': [
                { target: 'sheep', pay: 1, get: 1 }   // 1 –ú–∞–ª–∞ -> 1 –í—ñ–≤—Ü—è
            ],
            'big-dog': [
                { target: 'cow', pay: 1, get: 1 }     // 1 –í–µ–ª–∏–∫–∞ -> 1 –ö–æ—Ä–æ–≤–∞
            ]
        };

        const DIE_GREEN = [
            {id:'rabbit'}, {id:'rabbit'}, {id:'rabbit'}, {id:'rabbit'}, {id:'rabbit'}, {id:'rabbit'},
            {id:'sheep'}, {id:'sheep'}, {id:'sheep'}, {id:'pig'}, {id:'cow'}, {id:'wolf'}
        ].map(d => ({...d, icon: ICONS[d.id], name: NAMES[d.id]}));

        const DIE_RED = [
            {id:'rabbit'}, {id:'rabbit'}, {id:'rabbit'}, {id:'rabbit'}, {id:'rabbit'}, {id:'rabbit'},
            {id:'sheep'}, {id:'sheep'}, {id:'pig'}, {id:'pig'}, {id:'horse'}, {id:'fox'}
        ].map(d => ({...d, icon: ICONS[d.id], name: NAMES[d.id]}));

        // --- CORE ---
        const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        function getVal(id) { return parseInt(document.getElementById(`inp-${id}`).value) || 0; }
        function setVal(id, val) { 
            const el = document.getElementById(`inp-${id}`);
            el.value = Math.max(0, val);
            el.classList.remove('changed');
            void el.offsetWidth;
            el.classList.add('changed');
        }

        function playTone(type) {
            if (audioCtx.state === 'suspended') audioCtx.resume();
            const osc = audioCtx.createOscillator();
            const gain = audioCtx.createGain();
            osc.connect(gain);
            gain.connect(audioCtx.destination);
            const now = audioCtx.currentTime;
            
            if (type === 'roll') {
                osc.frequency.setValueAtTime(150, now);
                osc.frequency.linearRampToValueAtTime(50, now + 0.15);
                gain.gain.setValueAtTime(0.1, now);
                gain.gain.linearRampToValueAtTime(0, now + 0.15);
            } else if (type === 'trade') {
                osc.type = 'triangle';
                osc.frequency.setValueAtTime(600, now);
                gain.gain.setValueAtTime(0.1, now);
                gain.gain.linearRampToValueAtTime(0, now + 0.15);
            } else if (type === 'danger') {
                osc.type = 'sawtooth';
                osc.frequency.setValueAtTime(100, now);
                osc.frequency.linearRampToValueAtTime(50, now + 0.3);
                gain.gain.setValueAtTime(0.2, now);
                gain.gain.linearRampToValueAtTime(0, now + 0.3);
            }
            osc.start(); osc.stop(now + 0.5);
        }

        // --- DICE LOGIC ---
        function getSecureRandom(arr) {
            const cryptoArr = new Uint32Array(1);
            window.crypto.getRandomValues(cryptoArr);
            return arr[cryptoArr[0] % arr.length];
        }

        document.getElementById('rollBtn').addEventListener('click', () => {
            const btn = document.getElementById('rollBtn');
            const d1El = document.getElementById('d1');
            const d2El = document.getElementById('d2');
            const statusArea = document.getElementById('statusArea');

            btn.disabled = true;
            statusArea.innerHTML = '';
            d1El.classList.add('shaking');
            d2El.classList.add('shaking');
            playTone('roll');

            setTimeout(() => {
                d1El.classList.remove('shaking');
                d2El.classList.remove('shaking');
                btn.disabled = false;

                const r1 = getSecureRandom(DIE_GREEN);
                const r2 = getSecureRandom(DIE_RED);

                document.getElementById('d1-icon').innerText = r1.icon;
                document.getElementById('d1-label').innerText = r1.name;
                document.getElementById('d2-icon').innerText = r2.icon;
                document.getElementById('d2-label').innerText = r2.name;

                processRound(r1, r2);
            }, 500);
        });

        function processRound(r1, r2) {
            const statusArea = document.getElementById('statusArea');
            const autoMode = document.getElementById('autoMode').checked;
            
            let isWolf = (r1.id === 'wolf');
            let isFox = (r2.id === 'fox');

            if (isWolf || isFox) {
                playTone('danger');
                if (navigator.vibrate) navigator.vibrate([100, 50, 100]);
                let alertBox = document.createElement('div');
                alertBox.className = 'alert-box alert-danger';
                
                let msg = isWolf && isFox ? "–í–û–í–ö –¢–ê –õ–ò–°–ò–¶–Ø!" : (isWolf ? "–í–û–í–ö!" : "–õ–ò–°–ò–¶–Ø!");
                alertBox.innerHTML = `<span>‚ö†Ô∏è ${msg}</span>`;

                if (isFox) {
                    const group = document.createElement('div');
                    group.className = 'btn-action-group';
                    group.innerHTML = `<button class="btn btn-sm btn-secondary" onclick="useDog('small', this)">üêï -1 –°–æ–±–∞–∫–∞</button><button class="btn btn-sm btn-danger" onclick="applyFoxDamage(this)">ü¶ä –°–ø–∏—Å–∞—Ç–∏</button>`;
                    alertBox.appendChild(group);
                }
                if (isWolf) {
                    const group = document.createElement('div');
                    group.className = 'btn-action-group';
                    group.innerHTML = `<button class="btn btn-sm btn-secondary" onclick="useDog('big', this)">üêï‚Äçü¶∫ -1 –°–æ–±–∞–∫–∞</button><button class="btn btn-sm btn-danger" onclick="applyWolfDamage(this)">üê∫ –°–ø–∏—Å–∞—Ç–∏</button>`;
                    alertBox.appendChild(group);
                }
                statusArea.appendChild(alertBox);
                return;
            }

            // Normal Growth
            let counts = {};
            [r1, r2].forEach(r => counts[r.id] = (counts[r.id] || 0) + 1);
            let changes = [];
            
            ['rabbit', 'sheep', 'pig', 'cow', 'horse'].forEach(type => {
                let onDice = counts[type] || 0;
                if (onDice > 0) {
                    let onFarm = getVal(type);
                    let newBorn = Math.floor((onFarm + onDice) / 2);
                    if (newBorn > 0) {
                        changes.push(`+${newBorn} ${ICONS[type]}`);
                        if (autoMode) setVal(type, onFarm + newBorn);
                    }
                }
            });

            if (changes.length > 0) {
                playTone('trade'); // success tone
                let successBox = document.createElement('div');
                successBox.className = 'alert-box alert-success';
                successBox.innerHTML = `üéâ –ü—Ä–∏—Ä—ñ—Å—Ç:<br>${changes.join(', ')}`;
                statusArea.appendChild(successBox);
            } else {
                statusArea.innerHTML = '<div class="alert-info">–ë–µ–∑ –ø—Ä–∏—Ä–æ—Å—Ç—É</div>';
            }
            checkVictory();
        }

        // --- NEW TRADE UI LOGIC ---
        function openTradeModal() {
            document.getElementById('tradeModal').classList.add('active');
            renderSourceGrid();
        }
        function closeTradeModal() {
            document.getElementById('tradeModal').classList.remove('active');
        }

        function renderSourceGrid() {
            const grid = document.getElementById('sourceGrid');
            grid.innerHTML = '';
            
            // Order: Rabbit -> Big Dog
            const order = ['rabbit', 'sheep', 'pig', 'cow', 'horse', 'small-dog', 'big-dog'];
            
            order.forEach(id => {
                const el = document.createElement('div');
                el.className = 'source-item';
                el.onclick = () => selectSource(id, el);
                el.innerHTML = `
                    <div class="source-icon">${ICONS[id]}</div>
                    <div class="source-name">${NAMES[id]}</div>
                `;
                grid.appendChild(el);
            });
            
            // Auto-select first
            selectSource('rabbit', grid.firstChild);
        }

        function selectSource(sourceId, el) {
            // Highlight UI
            document.querySelectorAll('.source-item').forEach(i => i.classList.remove('active'));
            el.classList.add('active');

            // Show Offers
            const list = document.getElementById('offersList');
            list.innerHTML = '';
            
            const offers = OFFERS[sourceId];
            if (!offers || offers.length === 0) {
                list.innerHTML = '<div class="empty-offers">–ù–µ–º–∞—î –≤–∞—Ä—ñ–∞–Ω—Ç—ñ–≤ –æ–±–º—ñ–Ω—É –¥–ª—è —Ü—ñ—î—ó —Ç–≤–∞—Ä–∏–Ω–∏</div>';
                return;
            }

            offers.forEach(offer => {
                const card = document.createElement('div');
                card.className = 'offer-card';
                card.innerHTML = `
                    <div class="offer-info">
                        <span class="offer-text">–û—Ç—Ä–∏–º–∞—Ç–∏ ${offer.get} ${ICONS[offer.target]}</span>
                        <span class="offer-cost">–¶—ñ–Ω–∞: ${offer.pay} ${ICONS[sourceId]}</span>
                    </div>
                    <div class="offer-action">
                        <button class="trade-btn" onclick="executeTrade('${sourceId}', '${offer.target}', ${offer.pay}, ${offer.get})">
                            –ö—É–ø–∏—Ç–∏
                        </button>
                    </div>
                `;
                list.appendChild(card);
            });
        }

        function executeTrade(sourceId, targetId, cost, gain) {
            const currentSource = getVal(sourceId);
            
            if (currentSource >= cost) {
                if (confirm(`–û–±–º—ñ–Ω—è—Ç–∏ ${cost} ${NAMES[sourceId]} –Ω–∞ ${gain} ${NAMES[targetId]}?`)) {
                    setVal(sourceId, currentSource - cost);
                    setVal(targetId, getVal(targetId) + gain);
                    playTone('trade');
                    if (navigator.vibrate) navigator.vibrate(50);
                    checkVictory();
                }
            } else {
                alert(`–ù–µ –≤–∏—Å—Ç–∞—á–∞—î —Ç–≤–∞—Ä–∏–Ω! –ü–æ—Ç—Ä—ñ–±–Ω–æ ${cost} ${NAMES[sourceId]}, –∞ —î ${currentSource}.`);
            }
        }

        // --- HELPERS ---
        window.useDog = function(size, btn) {
            const id = size === 'small' ? 'small-dog' : 'big-dog';
            let current = getVal(id);
            if (current > 0) {
                setVal(id, current - 1);
                removeAlertButton(btn);
            } else { alert("–ù–µ–º–∞—î —Å–æ–±–∞–∫–∏!"); }
        }
        window.applyFoxDamage = function(btn) {
            if(confirm("–°–ø–∏—Å–∞—Ç–∏ –∑–∞–π—Ü—ñ–≤?")) { setVal('rabbit', 0); removeAlertButton(btn); }
        }
        window.applyWolfDamage = function(btn) {
            if(confirm("–°–ø–∏—Å–∞—Ç–∏ –æ–≤–µ—Ü—å, —Å–≤–∏–Ω–µ–π —Ç–∞ –∫–æ—Ä—ñ–≤?")) { setVal('sheep', 0); setVal('pig', 0); setVal('cow', 0); removeAlertButton(btn); }
        }
        function removeAlertButton(btn) { 
            btn.parentElement.style.opacity = '0.5'; 
            btn.parentElement.style.pointerEvents = 'none'; 
        }

        function checkVictory() {
            if (getVal('rabbit')>0 && getVal('sheep')>0 && getVal('pig')>0 && 
                getVal('cow')>0 && getVal('horse')>0) {
                let winBox = document.createElement('div');
                winBox.className = 'alert-box alert-success';
                winBox.innerHTML = `üèÜ <b>–°–£–ü–ï–† –§–ï–†–ú–ï–†!</b><br>–í–∏ –∑—ñ–±—Ä–∞–ª–∏ –≤—Å—ñ—Ö —Ç–≤–∞—Ä–∏–Ω!`;
                document.getElementById('statusArea').prepend(winBox);
                if (navigator.vibrate) navigator.vibrate([200,100,200,100,500]);
            }
        }

        if ('serviceWorker' in navigator) navigator.serviceWorker.register('sw.js');
    </script>
</body>
</html>
