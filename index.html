<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>–°—É–ø–µ—Ä –§–µ—Ä–º–µ—Ä Online</title>
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#10b981">
    
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons+Round" rel="stylesheet">
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    
    <style>
        :root {
            --primary: #10b981;
            --bg: #f1f5f9;
            --surface: #ffffff;
            --text-main: #1e293b;
            --text-light: #64748b;
            --danger: #ef4444;
            --border: #e2e8f0;
            --nav-height: 65px;
        }

        body {
            font-family: 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            background-color: var(--bg); color: var(--text-main);
            margin: 0; padding: 0; height: 100vh;
            display: flex; flex-direction: column; overflow: hidden;
            -webkit-tap-highlight-color: transparent;
        }

        /* --- VIEWS MANAGEMENT --- */
        .view-container {
            flex: 1; overflow-y: auto; padding: 20px;
            padding-bottom: 90px; display: none;
            opacity: 0; transition: opacity 0.2s;
        }
        .view-container.active { display: block; opacity: 1; }

        /* --- TYPOGRAPHY & CARDS --- */
        h1, h2, h3 { margin: 0; }
        .header-title { font-size: 1.5rem; font-weight: 800; margin-bottom: 20px; color: var(--text-main); }
        .card {
            background: var(--surface); border-radius: 16px; padding: 16px;
            box-shadow: 0 4px 6px -1px rgba(0,0,0,0.05); margin-bottom: 12px;
            border: 1px solid var(--border);
        }

        /* --- FARM GRID --- */
        .farm-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; }
        .animal-card {
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            background: #f8fafc; border-radius: 12px; padding: 12px 4px;
            border: 2px solid transparent; transition: all 0.3s; position: relative;
        }
        .animal-card.has-items { background: #ecfdf5; border-color: #34d399; }
        .animal-icon { font-size: 2rem; margin-bottom: 4px; }
        .animal-count { font-size: 1.2rem; font-weight: 800; color: var(--text-main); }
        .animal-name { font-size: 0.7rem; color: var(--text-light); text-transform: uppercase; font-weight: 600; }

        /* --- GAME ARENA --- */
        .dice-stage {
            background: #cbd5e1; border-radius: 20px; height: 180px;
            display: flex; justify-content: center; align-items: center; gap: 20px;
            margin-bottom: 20px; position: relative; box-shadow: inset 0 2px 6px rgba(0,0,0,0.1);
        }
        .die {
            width: 70px; height: 70px; background: white; border-radius: 14px;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            font-size: 2.2rem; box-shadow: 0 8px 0 #94a3b8; border: 1px solid #fff;
            transition: transform 0.2s;
        }
        .die:active { transform: translateY(4px); box-shadow: 0 4px 0 #94a3b8; }
        .die.green { border-bottom: 4px solid #4ade80; }
        .die.red { border-bottom: 4px solid #f87171; }
        .turn-indicator {
            position: absolute; top: 10px; left: 50%; transform: translateX(-50%);
            background: rgba(255,255,255,0.9); padding: 4px 12px; border-radius: 20px;
            font-size: 0.8rem; font-weight: bold; color: var(--text-main);
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .btn-main {
            width: 100%; padding: 16px; border-radius: 12px; border: none;
            background: var(--primary); color: white; font-size: 1.1rem; font-weight: 700;
            box-shadow: 0 4px 0 #059669; cursor: pointer; text-transform: uppercase;
            transition: all 0.1s;
        }
        .btn-main:active { transform: translateY(4px); box-shadow: none; }
        .btn-main:disabled { background: #cbd5e1; box-shadow: none; color: #94a3b8; cursor: not-allowed; transform: translateY(4px); }

        /* --- MARKET --- */
        .market-item {
            display: flex; justify-content: space-between; align-items: center;
            padding: 12px 0; border-bottom: 1px solid var(--border);
        }
        .market-item:last-child { border-bottom: none; }
        .trade-arrow { color: var(--text-light); margin: 0 8px; font-size: 0.9rem; }
        .btn-buy {
            padding: 8px 14px; background: var(--text-main); color: white;
            border: none; border-radius: 8px; font-weight: 600; cursor: pointer;
        }
        .btn-buy:active { transform: scale(0.95); }

        /* --- LOBBY --- */
        #lobby-screen {
            position: fixed; inset: 0; z-index: 200; background: var(--bg);
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            padding: 30px;
        }
        .lobby-input {
            width: 100%; max-width: 280px; padding: 15px; margin: 10px 0;
            border: 2px solid var(--border); border-radius: 12px;
            font-size: 1.2rem; text-align: center; font-weight: bold; letter-spacing: 2px;
            text-transform: uppercase;
        }
        .lobby-btn {
            width: 100%; max-width: 300px; padding: 16px; margin: 8px 0;
            border-radius: 12px; border: none; font-weight: bold; font-size: 1rem;
            cursor: pointer; text-transform: uppercase;
        }
        .btn-create { background: var(--primary); color: white; }
        .btn-join { background: white; border: 2px solid var(--border); color: var(--text-main); }
        .lobby-code-display {
            font-size: 3rem; font-weight: 900; color: var(--primary);
            letter-spacing: 4px; margin: 20px 0; text-shadow: 0 2px 0 rgba(0,0,0,0.1);
            cursor: pointer;
        }

        /* --- BOTTOM NAV --- */
        .bottom-nav {
            position: fixed; bottom: 0; left: 0; width: 100%; height: var(--nav-height);
            background: var(--surface); border-top: 1px solid var(--border);
            display: flex; justify-content: space-around; align-items: center; z-index: 100;
            padding-bottom: env(safe-area-inset-bottom);
        }
        .nav-item {
            flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: center;
            height: 100%; color: #94a3b8; text-decoration: none; font-size: 0.7rem; font-weight: 600;
            cursor: pointer; transition: color 0.2s;
        }
        .nav-item.active { color: var(--primary); }
        .nav-item .material-icons-round { font-size: 26px; margin-bottom: 2px; }

        /* --- UTILS --- */
        .toast {
            position: fixed; top: 20px; left: 50%; transform: translateX(-50%);
            background: #334155; color: white; padding: 10px 20px; border-radius: 30px;
            font-size: 0.9rem; z-index: 300; opacity: 0; pointer-events: none; transition: opacity 0.3s;
            box-shadow: 0 4px 12px rgba(0,0,0,0.2); white-space: nowrap;
        }
        .toast.show { opacity: 1; }
        
        .shaking { animation: shake 0.5s infinite; }
        @keyframes shake { 0%{transform:rotate(0)} 25%{transform:rotate(8deg)} 75%{transform:rotate(-8deg)} }
    </style>
</head>
<body>

    <div id="lobby-screen">
        <div style="font-size: 3rem; margin-bottom: 10px;">üê∑</div>
        <h2 style="margin-bottom: 30px; color: var(--text-light);">–°—É–ø–µ—Ä –§–µ—Ä–º–µ—Ä Online</h2>
        
        <div id="lobby-start">
            <button class="lobby-btn btn-create" onclick="setupHost()">–°—Ç–≤–æ—Ä–∏—Ç–∏ –≥—Ä—É</button>
            <button class="lobby-btn btn-join" onclick="showJoinUI()">–ü—Ä–∏—î–¥–Ω–∞—Ç–∏—Å—è</button>
        </div>

        <div id="lobby-host" style="display:none; text-align:center; width: 100%;">
            <div style="color:var(--text-light)">–í–∞—à –∫–æ–¥ –≥—Ä–∏:</div>
            <div id="host-code" class="lobby-code-display" onclick="copyCode()">...</div>
            <div style="font-size:0.9rem; color:#64748b; margin-bottom:20px;">–û—á—ñ–∫—É–≤–∞–Ω–Ω—è –≥—Ä–∞–≤—Ü—è...</div>
            <div class="loader"></div>
            <button class="lobby-btn btn-join" onclick="location.reload()">–°–∫–∞—Å—É–≤–∞—Ç–∏</button>
        </div>

        <div id="lobby-join" style="display:none; text-align:center; width: 100%;">
            <div style="color:var(--text-light)">–í–≤–µ–¥—ñ—Ç—å –∫–æ–¥ –≥—Ä–∏:</div>
            <input type="text" id="join-code-input" class="lobby-input" placeholder="CODE" maxlength="6">
            <button class="lobby-btn btn-create" onclick="joinGame()">–£–≤—ñ–π—Ç–∏</button>
            <button class="lobby-btn btn-join" onclick="location.reload()">–ù–∞–∑–∞–¥</button>
        </div>
    </div>

    <div id="view-farm" class="view-container">
        <div class="header-title">–ú–æ—è –§–µ—Ä–º–∞</div>
        
        <div class="card">
            <div class="farm-grid">
                <div class="animal-card" id="card-rabbit"><div class="animal-icon">üê∞</div><div class="animal-count" id="c-rabbit">0</div><div class="animal-name">–ó–∞–π—Ü—ñ</div></div>
                <div class="animal-card" id="card-sheep"><div class="animal-icon">üêë</div><div class="animal-count" id="c-sheep">0</div><div class="animal-name">–í—ñ–≤—Ü—ñ</div></div>
                <div class="animal-card" id="card-pig"><div class="animal-icon">üê∑</div><div class="animal-count" id="c-pig">0</div><div class="animal-name">–°–≤–∏–Ω—ñ</div></div>
                <div class="animal-card" id="card-cow"><div class="animal-icon">üêÆ</div><div class="animal-count" id="c-cow">0</div><div class="animal-name">–ö–æ—Ä–æ–≤–∏</div></div>
                <div class="animal-card" id="card-horse"><div class="animal-icon">üê¥</div><div class="animal-count" id="c-horse">0</div><div class="animal-name">–ö–æ–Ω—ñ</div></div>
                <div class="animal-card" id="card-small-dog"><div class="animal-icon">üêï</div><div class="animal-count" id="c-small-dog">0</div><div class="animal-name">–ú–∞–ª–∞</div></div>
                <div class="animal-card" id="card-big-dog"><div class="animal-icon">üêï‚Äçü¶∫</div><div class="animal-count" id="c-big-dog">0</div><div class="animal-name">–í–µ–ª–∏–∫–∞</div></div>
            </div>
        </div>
        <div style="text-align:center; font-size:0.8rem; color:#94a3b8; margin-top:20px">
            –ó–±–∏—Ä–∞–π —Ç–≤–∞—Ä–∏–Ω, —â–æ–± –ø–µ—Ä–µ–º–æ–≥—Ç–∏!<br>–ü–æ—Ç—Ä—ñ–±–µ–Ω —Ö–æ—á–∞ –± 1 –ø—Ä–µ–¥—Å—Ç–∞–≤–Ω–∏–∫ –∫–æ–∂–Ω–æ–≥–æ –≤–∏–¥—É (–∫—Ä—ñ–º —Å–æ–±–∞–∫).
        </div>
    </div>

    <div id="view-game" class="view-container">
        <div class="header-title">–ê—Ä–µ–Ω–∞</div>
        
        <div class="dice-stage">
            <div class="turn-indicator" id="turn-badge">–û—á—ñ–∫—É–≤–∞–Ω–Ω—è...</div>
            <div id="die1" class="die green">üé≤</div>
            <div id="die2" class="die red">üé≤</div>
        </div>

        <button id="rollBtn" class="btn-main" onclick="requestRoll()" disabled>üé≤ –ö–∏–Ω—É—Ç–∏ –∫—É–±–∏–∫–∏</button>

        <div class="header-title" style="font-size: 1.1rem; margin-top: 30px;">–ü–æ–¥—ñ—ó</div>
        <div id="game-log" style="font-size: 0.9rem; color: var(--text-light); display: flex; flex-direction: column; gap: 8px;">
            <div style="padding:10px; background:#fff; border-radius:8px; border:1px solid #e2e8f0">–ì—Ä–∞ –ø–æ—á–∏–Ω–∞—î—Ç—å—Å—è!</div>
        </div>
    </div>

    <div id="view-market" class="view-container">
        <div class="header-title">–†–∏–Ω–æ–∫</div>
        <div class="card">
            <div id="market-list">
                <div style="padding:20px; text-align:center; color:#94a3b8">–ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –ø—Ä–æ–ø–æ–∑–∏—Ü—ñ–π...</div>
            </div>
        </div>
    </div>

    <div id="view-rivals" class="view-container">
        <div class="header-title">–°—É–ø–µ—Ä–Ω–∏–∫–∏</div>
        <div id="rivals-list">
            </div>
    </div>

    <nav class="bottom-nav" id="main-nav" style="display:none">
        <a class="nav-item" onclick="switchTab('view-farm', this)">
            <span class="material-icons-round">cottage</span><span>–§–µ—Ä–º–∞</span>
        </a>
        <a class="nav-item active" onclick="switchTab('view-game', this)">
            <span class="material-icons-round">casino</span><span>–ì—Ä–∞</span>
        </a>
        <a class="nav-item" onclick="switchTab('view-market', this)">
            <span class="material-icons-round">storefront</span><span>–†–∏–Ω–æ–∫</span>
        </a>
        <a class="nav-item" onclick="switchTab('view-rivals', this)">
            <span class="material-icons-round">groups</span><span>–ì—Ä–∞–≤—Ü—ñ</span>
        </a>
    </nav>

    <div id="toast" class="toast">–ü–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è</div>

    <script>
        // --- CONFIG ---
        const PEER_PREFIX = 'super-farmer-ua-';
        const CONFIG = {
            rabbit: 60, sheep: 24, pig: 20, cow: 12, horse: 6,
            'small-dog': 4, 'big-dog': 2
        };
        const ICONS = {rabbit:'üê∞', sheep:'üêë', pig:'üê∑', cow:'üêÆ', horse:'üê¥', 'small-dog':'üêï', 'big-dog':'üêï‚Äçü¶∫', wolf:'üê∫', fox:'ü¶ä'};
        const NAMES = {rabbit:'–ó–∞—î—Ü—å', sheep:'–í—ñ–≤—Ü—è', pig:'–°–≤–∏–Ω—è', cow:'–ö–æ—Ä–æ–≤–∞', horse:'–ö—ñ–Ω—å', 'small-dog':'–ú–∞–ª–∞', 'big-dog':'–í–µ–ª–∏–∫–∞'};

        // --- STATE ---
        let myId = null;
        let hostId = null;
        let conn = null;
        let isHost = false;
        let peer = null;

        // Game State (Synced from Host)
        let gameState = {
            players: [], // {id, name, farm}
            turnIdx: 0,
            bank: {...CONFIG},
            log: []
        };

        // --- P2P SETUP ---
        function setupHost() {
            document.getElementById('lobby-start').style.display = 'none';
            document.getElementById('lobby-host').style.display = 'block';
            
            // Random short code
            const shortCode = Math.floor(1000 + Math.random() * 9000);
            myId = PEER_PREFIX + shortCode;
            
            document.getElementById('host-code').innerText = shortCode;

            peer = new Peer(myId);
            
            peer.on('open', (id) => {
                isHost = true;
                // Init Game State for Host
                gameState.players.push({id: myId, name: "–ì–æ—Å–ø–æ–¥–∞—Ä", farm: getEmptyFarm()});
                showToast("–ì—Ä—É —Å—Ç–≤–æ—Ä–µ–Ω–æ! –ß–µ–∫–∞—î–º–æ –≥—Ä–∞–≤—Ü—è...");
            });

            peer.on('connection', (c) => {
                conn = c;
                setupConnection();
                // Add new player
                gameState.players.push({id: c.peer, name: "–ì—ñ—Å—Ç—å", farm: getEmptyFarm()});
                sendState(); // Send initial state
                startGameUI();
                showToast("–ì—Ä–∞–≤–µ—Ü—å –ø—Ä–∏—î–¥–Ω–∞–≤—Å—è!");
            });
            
            peer.on('error', err => alert("–ü–æ–º–∏–ª–∫–∞ –∑'—î–¥–Ω–∞–Ω–Ω—è: " + err));
        }

        function joinGame() {
            const code = document.getElementById('join-code-input').value;
            if(!code) return;
            
            hostId = PEER_PREFIX + code;
            peer = new Peer(); // Auto ID
            
            peer.on('open', (id) => {
                myId = id;
                conn = peer.connect(hostId);
                setupConnection();
            });

            peer.on('error', err => {
                showToast("–ì—Ä—É –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–æ :(");
                console.error(err);
            });
        }

        function setupConnection() {
            conn.on('open', () => {
                if(!isHost) {
                    showToast("–ü—ñ–¥–∫–ª—é—á–µ–Ω–æ –¥–æ –≥—Ä–∏!");
                    startGameUI();
                }
            });

            conn.on('data', (data) => {
                handleData(data);
            });
            
            conn.on('close', () => alert("–ó'—î–¥–Ω–∞–Ω–Ω—è —Ä–æ–∑—ñ—Ä–≤–∞–Ω–æ"));
        }

        function sendData(type, payload) {
            if(conn && conn.open) conn.send({type, payload});
        }

        // --- LOGIC (HOST ONLY) ---
        function handleData(data) {
            // If I am Guest, I only receive STATE updates
            if (!isHost) {
                if (data.type === 'STATE_UPDATE') {
                    gameState = data.payload;
                    updateUI();
                }
                return;
            }

            // If I am Host, I process commands
            if (isHost) {
                const player = gameState.players.find(p => p.id === conn.peer);
                
                if (data.type === 'CMD_ROLL') {
                    if (gameState.players[gameState.turnIdx].id !== player.id) return;
                    performRoll(player);
                }
                
                if (data.type === 'CMD_TRADE') {
                    if (gameState.players[gameState.turnIdx].id !== player.id) return;
                    performTrade(player, data.payload);
                }
            }
        }

        // --- GAME ACTIONS (HOST) ---
        function performRoll(player) {
            // Dice Logic
            const D_GREEN = ['rabbit','rabbit','rabbit','rabbit','rabbit','rabbit','sheep','sheep','sheep','pig','cow','wolf'];
            const D_RED = ['rabbit','rabbit','rabbit','rabbit','rabbit','rabbit','sheep','sheep','pig','pig','horse','fox'];
            
            const r1 = D_GREEN[Math.floor(Math.random() * D_GREEN.length)];
            const r2 = D_RED[Math.floor(Math.random() * D_RED.length)];
            
            let logMsg = `–í–∏–ø–∞–ª–æ: ${ICONS[r1]} ${ICONS[r2]}`;
            
            // Process Results
            let farm = player.farm;
            let bank = gameState.bank;
            
            // 1. Predators
            if(r1 === 'wolf' || r2 === 'fox') {
                if(r1 === 'wolf') {
                    if(farm['big-dog'] > 0) {
                        farm['big-dog']--; bank['big-dog']++;
                        logMsg += " | üêï‚Äçü¶∫ –í—Ä—è—Ç—É–≤–∞–≤!";
                    } else {
                        ['sheep','pig','cow'].forEach(k => { bank[k]+=farm[k]; farm[k]=0; });
                        logMsg += " | üê∫ –ó'—ó–≤ —Å—Ç–∞–¥–æ!";
                    }
                }
                if(r2 === 'fox') {
                    if(farm['small-dog'] > 0) {
                        farm['small-dog']--; bank['small-dog']++;
                        logMsg += " | üêï –í—Ä—è—Ç—É–≤–∞–ª–∞!";
                    } else {
                        bank['rabbit']+=farm['rabbit']; farm['rabbit']=0;
                        logMsg += " | ü¶ä –ó'—ó–ª–∞ –∑–∞–π—Ü—ñ–≤!";
                    }
                }
            } else {
                // 2. Growth
                let counts = {};
                [r1, r2].forEach(x => counts[x] = (counts[x]||0)+1);
                let bornStr = [];
                
                ['rabbit','sheep','pig','cow','horse'].forEach(type => {
                    let onDice = counts[type] || 0;
                    if(onDice > 0) {
                        let total = farm[type] + onDice;
                        let born = Math.floor(total / 2);
                        if(born > 0) {
                            if(bank[type] >= born) {
                                bank[type] -= born; farm[type] += born;
                                bornStr.push(`+${born}${ICONS[type]}`);
                            } else if(bank[type] > 0) {
                                let left = bank[type];
                                bank[type]=0; farm[type]+=left;
                                bornStr.push(`+${left}${ICONS[type]}`);
                            }
                        }
                    }
                });
                if(bornStr.length > 0) logMsg += " | " + bornStr.join(' ');
            }

            // Next Turn
            gameState.turnIdx = (gameState.turnIdx + 1) % gameState.players.length;
            
            // Add Log
            gameState.log.unshift({msg: logMsg, dice: [r1, r2]});
            if(gameState.log.length > 20) gameState.log.pop();

            sendState();
            updateUI(); // Host UI update
            checkWin(player);
        }

        function performTrade(player, tradeData) {
            // tradeData: {give: 'rabbit', get: 'sheep', countGive: 6, countGet: 1}
            // Basic verification done on client, host double checks
            if(player.farm[tradeData.give] >= tradeData.countGive && gameState.bank[tradeData.get] >= tradeData.countGet) {
                player.farm[tradeData.give] -= tradeData.countGive;
                gameState.bank[tradeData.give] += tradeData.countGive;
                
                player.farm[tradeData.get] += tradeData.countGet;
                gameState.bank[tradeData.get] -= tradeData.countGet;
                
                gameState.log.unshift({msg: `–û–±–º—ñ–Ω: ${tradeData.countGive}${ICONS[tradeData.give]} ‚û°Ô∏è ${tradeData.countGet}${ICONS[tradeData.get]}`});
                sendState();
                updateUI();
                checkWin(player);
            }
        }
        
        function sendState() {
            // Broadcast to guest (if I am host)
            if(conn && conn.open) conn.send({type: 'STATE_UPDATE', payload: gameState});
        }
        
        function checkWin(player) {
            const f = player.farm;
            if(f.rabbit && f.sheep && f.pig && f.cow && f.horse) {
                alert(`üèÜ ${player.name} –ü–ï–†–ï–ú–Ü–ì!`);
            }
        }

        // --- CLIENT COMMANDS ---
        function requestRoll() {
            if(isHost) {
                const me = gameState.players.find(p => p.id === myId);
                performRoll(me); // Host does it locally
            } else {
                sendData('CMD_ROLL', null); // Guest sends request
            }
        }
        
        function requestTrade(give, get, cGive, cGet) {
             if(isHost) {
                 const me = gameState.players.find(p => p.id === myId);
                 performTrade(me, {give, get, countGive: cGive, countGet: cGet});
             } else {
                 sendData('CMD_TRADE', {give, get, countGive: cGive, countGet: cGet});
             }
        }

        // --- UI RENDERING ---
        function startGameUI() {
            document.getElementById('lobby-screen').style.display = 'none';
            document.getElementById('main-nav').style.display = 'flex';
            switchTab('view-game', document.querySelectorAll('.nav-item')[1]);
            updateUI();
        }

        function updateUI() {
            const me = gameState.players.find(p => p.id === myId);
            const currentTurnPlayer = gameState.players[gameState.turnIdx];
            const isMyTurn = currentTurnPlayer.id === myId;

            // 1. UPDATE FARM
            if(me) {
                for(let k in me.farm) {
                    const el = document.getElementById(`c-${k}`);
                    const card = document.getElementById(`card-${k}`);
                    if(el) {
                        el.innerText = me.farm[k];
                        if(me.farm[k] > 0) card.classList.add('has-items');
                        else card.classList.remove('has-items');
                    }
                }
            }

            // 2. UPDATE GAME ARENA
            const badge = document.getElementById('turn-badge');
            const rollBtn = document.getElementById('rollBtn');
            
            badge.innerText = isMyTurn ? "–í–ê–® –•–Ü–î" : `–•—ñ–¥: ${currentTurnPlayer.name}`;
            badge.style.color = isMyTurn ? "var(--primary)" : "var(--text-light)";
            
            rollBtn.disabled = !isMyTurn;
            rollBtn.innerText = isMyTurn ? "üé≤ –ö–ò–ù–£–¢–ò –ö–£–ë–ò–ö–ò" : "–û—á—ñ–∫—É–≤–∞–Ω–Ω—è...";

            // Dice & Log
            const logBox = document.getElementById('game-log');
            logBox.innerHTML = gameState.log.map(l => {
                return `<div style="padding:10px; background:#fff; border-radius:8px; border:1px solid #e2e8f0; font-size:0.85rem">${l.msg}</div>`;
            }).join('');
            
            if(gameState.log.length > 0 && gameState.log[0].dice) {
                const lastDice = gameState.log[0].dice;
                document.getElementById('die1').innerText = ICONS[lastDice[0]] || '‚ùì';
                document.getElementById('die2').innerText = ICONS[lastDice[1]] || '‚ùì';
            }

            // 3. UPDATE RIVALS
            const rivalsBox = document.getElementById('rivals-list');
            rivalsBox.innerHTML = gameState.players.filter(p => p.id !== myId).map(p => `
                <div class="card">
                    <div style="font-weight:bold; margin-bottom:5px">${p.name}</div>
                    <div style="font-size:1.2rem">${ICONS.rabbit}${p.farm.rabbit} ${ICONS.sheep}${p.farm.sheep} ${ICONS.pig}${p.farm.pig} ${ICONS.cow}${p.farm.cow} ${ICONS.horse}${p.farm.horse}</div>
                </div>
            `).join('');

            // 4. UPDATE MARKET (Smart)
            renderMarket(me, isMyTurn);
        }

        function renderMarket(me, isMyTurn) {
            const list = document.getElementById('market-list');
            if(!me) return;
            
            const TRADES = [
                {g:'rabbit', t:'sheep', p:6, r:1},
                {g:'sheep', t:'rabbit', p:1, r:6},
                {g:'sheep', t:'pig', p:2, r:1}, {g:'pig', t:'sheep', p:1, r:2},
                {g:'sheep', t:'small-dog', p:1, r:1},
                {g:'pig', t:'cow', p:3, r:1}, {g:'cow', t:'pig', p:1, r:3},
                {g:'cow', t:'horse', p:2, r:1}, {g:'horse', t:'cow', p:1, r:2},
                {g:'cow', t:'big-dog', p:1, r:1}
            ];

            let html = '';
            TRADES.forEach(tr => {
                const canAfford = me.farm[tr.g] >= tr.p;
                const bankHas = gameState.bank[tr.t] >= tr.r;
                
                html += `
                <div class="market-item" style="opacity:${(canAfford && bankHas) ? 1 : 0.5}">
                    <div style="font-size:1.1rem"><b>${tr.p}</b> ${ICONS[tr.g]}</div>
                    <div class="trade-arrow">‚û°Ô∏è</div>
                    <div style="font-size:1.1rem"><b>${tr.r}</b> ${ICONS[tr.t]}</div>
                    <button class="btn-buy" 
                        onclick="requestTrade('${tr.g}','${tr.t}',${tr.p},${tr.r})"
                        ${(!canAfford || !bankHas || !isMyTurn) ? 'disabled' : ''}
                        style="background:${(canAfford && bankHas && isMyTurn) ? 'var(--text-main)' : '#cbd5e1'}"
                    >–û–±–º—ñ–Ω</button>
                </div>`;
            });
            list.innerHTML = html || '<div style="text-align:center">–†–∏–Ω–æ–∫ –ø—É—Å—Ç–∏–π</div>';
        }

        // --- HELPERS ---
        function getEmptyFarm() { return {rabbit:0, sheep:0, pig:0, cow:0, horse:0, 'small-dog':0, 'big-dog':0}; }
        
        function switchTab(id, el) {
            document.querySelectorAll('.view-container').forEach(d => {d.classList.remove('active'); setTimeout(()=>d.style.display='none', 200)});
            document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
            
            const target = document.getElementById(id);
            target.style.display = 'block';
            setTimeout(() => target.classList.add('active'), 10);
            el.classList.add('active');
        }

        function showToast(msg) {
            const t = document.getElementById('toast');
            t.innerText = msg; t.classList.add('show');
            setTimeout(() => t.classList.remove('show'), 3000);
        }
        
        function copyCode() {
            const code = document.getElementById('host-code').innerText;
            navigator.clipboard.writeText(code).then(() => showToast("–ö–æ–¥ —Å–∫–æ–ø—ñ–π–æ–≤–∞–Ω–æ!"));
        }

        function showJoinUI() {
            document.getElementById('lobby-start').style.display = 'none';
            document.getElementById('lobby-join').style.display = 'block';
        }
    </script>
</body>
</html>
